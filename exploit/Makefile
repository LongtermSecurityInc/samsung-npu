# Program paths
ADB := adb

# ----------------------------------------------------------------------------
# Change these variables based on your environment
NDK_PATH := /opt/android-ndk
NDK_PREBUILTS := $(NDK_PATH)/toolchains/llvm/prebuilt/darwin-x86_64/bin
PAYLOAD_SRC := bof_payload.c
# ---------------------------------------------------------------------------

# Local environment
OBJCOPY := $(NDK_PREBUILTS)/aarch64-linux-android-objcopy
CC := $(NDK_PREBUILTS)/aarch64-linux-android29-clang
SYMFILE := symbols.ld
CFLAGS := -T$(SYMFILE) -fPIC --target=arm-none-eabi -march=armv7a -nostdlib
CFLAGS+=-fpie -ffreestanding -ffunction-sections  -fomit-frame-pointer

# Local directories
POC_SRC := exploit.c
POC := exploit
PAYLOAD := payload.bin

# Device directories
DEVICE_DIR := /data/local/tmp


.DEFAULT_GOAL := build

payload:
	$(CC) $(CFLAGS) -o $(PAYLOAD) $(PAYLOAD_SRC)
	$(OBJCOPY) -O binary --strip-all $(PAYLOAD)

build: payload
	$(CC) -o $(POC) $(POC_SRC)

push: build
	$(ADB) wait-for-device push $(POC) $(DEVICE_DIR)
	$(ADB) wait-for-device push $(PAYLOAD) $(DEVICE_DIR)

run: push
	$(ADB) wait-for-device shell \
		su root sh -c "$(DEVICE_DIR)/$(POC) /data/local/tmp/"

reboot:
	$(ADB) wait-for-device shell reboot
